<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tiny Tower Â· Staff Optimizer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');

:root {
  --panel-gray: #b8c8d4;
  --panel-dark: #8fa8b8;
  --panel-light: #d8e8f0;
  --floor-hdr: #6888a0;
  --floor-stripe: #a8bece;
  --border-dark: #3a5060;
  --border-mid: #6888a0;
  --text-dark: #1a2a36;
  --text-mid: #2a4050;
  --text-light: #ffffff;
  --muted: #5a7888;
  --food: #e03030;
  --service: #d07800;
  --recreation: #148828;
  --creative: #8820b0;
  --retail: #1060c0;
  --accent: #f0c000;
  --accent-dark: #a07800;
  --green: #30a830;
  --green-dark: #1a6018;
  --red: #c02020;
  --nav-h: 56px;
  --hdr-h: 58px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'VT323', monospace;
  font-size: 18px;
  background:
    radial-gradient(ellipse 140px 45px at 10% 12%, rgba(255,255,255,0.55) 0%, transparent 70%),
    radial-gradient(ellipse 90px 30px at 70% 6%, rgba(255,255,255,0.4) 0%, transparent 70%),
    linear-gradient(180deg, #7ad8f8 0%, #5ec8f0 35%, #48b8e0 100%);
  background-attachment: fixed;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ App Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header {
  flex-shrink: 0;
  height: var(--hdr-h);
  background: var(--floor-hdr);
  border-bottom: 4px solid var(--border-dark);
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 10px;
  box-shadow: 0 3px 0 var(--border-dark);
  position: relative;
  z-index: 10;
}

.tower-art { width: 36px; height: 48px; flex-shrink: 0; image-rendering: pixelated; }

.logo {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  color: white;
  text-shadow: 2px 2px 0 var(--border-dark);
  line-height: 1.7;
}

.tagline { font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 1px; }

.header-badges {
  margin-left: auto;
  display: flex;
  gap: 6px;
}

.badge {
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  background: var(--border-dark);
  color: var(--accent);
  border: 2px solid var(--accent);
  padding: 3px 6px;
  white-space: nowrap;
}

/* â”€â”€ Page content area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pages {
  flex: 1;
  position: relative;
  overflow: hidden;
}

.page {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px 12px 20px;
  display: none;
}

.page.active { display: block; }

/* â”€â”€ Bottom Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav {
  flex-shrink: 0;
  height: var(--nav-h);
  display: flex;
  border-top: 4px solid var(--border-dark);
  background: var(--floor-hdr);
  box-shadow: 0 -3px 0 var(--border-dark);
  position: relative;
  z-index: 10;
}

.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  border: none;
  background: var(--panel-dark);
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  border-right: 2px solid var(--border-dark);
  font-family: 'VT323', monospace;
  font-size: 13px;
  transition: background 0.05s;
  position: relative;
}

.nav-btn:last-child { border-right: none; }

.nav-btn.active {
  background: var(--panel-light);
  color: var(--text-dark);
}

.nav-btn .nav-icon { font-size: 20px; line-height: 1; }

.nav-badge {
  position: absolute;
  top: 4px; right: 10px;
  background: var(--red);
  color: white;
  font-family: 'Press Start 2P', monospace;
  font-size: 6px;
  padding: 1px 4px;
  border: 1px solid var(--border-dark);
  min-width: 16px;
  text-align: center;
}

/* â”€â”€ Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  background: var(--panel-gray);
  border: 3px solid var(--border-dark);
  box-shadow: 3px 3px 0 var(--border-dark);
  margin-bottom: 12px;
}

.panel-hdr {
  background: var(--floor-hdr);
  border-bottom: 3px solid var(--border-dark);
  padding: 8px 12px;
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: white;
  text-shadow: 1px 1px 0 var(--border-dark);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.panel-body { padding: 12px; }

/* â”€â”€ Inner tabs (Residents / Shops inside Data Entry) */
.inner-tabs {
  display: flex;
  border: 3px solid var(--border-dark);
  margin-bottom: 12px;
  gap: 2px;
  background: var(--border-dark);
}

.inner-tab {
  flex: 1;
  padding: 6px 4px;
  text-align: center;
  cursor: pointer;
  font-size: 15px;
  color: rgba(255,255,255,0.75);
  border: none;
  background: var(--panel-dark);
  font-family: 'VT323', monospace;
}

.inner-tab.active { background: var(--panel-light); color: var(--text-dark); }

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 9px; }

label {
  display: block;
  font-size: 15px;
  color: var(--text-mid);
  margin-bottom: 3px;
}

input[type="text"], select {
  width: 100%;
  background: var(--panel-light);
  border: 3px solid var(--border-dark);
  color: var(--text-dark);
  padding: 8px 9px;
  font-size: 18px;
  font-family: 'VT323', monospace;
  outline: none;
  border-radius: 0;
  appearance: none;
}

input[type="text"]:focus, select:focus { border-color: var(--accent); background: #fff; }
select option { background: var(--panel-light); color: var(--text-dark); }

/* â”€â”€ Skill grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skill-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 5px;
  margin-bottom: 9px;
}

.skill-item {
  background: var(--panel-dark);
  border: 2px solid var(--border-mid);
  padding: 5px 6px;
  min-width: 0;
  overflow: hidden;
}

.skill-item label {
  margin-bottom: 2px;
  font-size: 13px;
  color: var(--text-light);
  display: flex;
  align-items: center;
  gap: 4px;
}

.skill-dot { width: 8px; height: 8px; display: inline-block; flex-shrink: 0; }

.skill-input-wrap {
  display: flex;
  align-items: center;
  gap: 4px;
  min-width: 0;
}

input[type="range"] {
  flex: 1 1 0;
  min-width: 0;
  width: 0;
  accent-color: var(--accent);
  cursor: pointer;
}

.skill-val {
  font-size: 19px;
  width: 18px;
  text-align: right;
  color: var(--accent);
  flex-shrink: 0;
}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  width: 100%;
  padding: 10px;
  cursor: pointer;
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  border: 3px solid var(--border-dark);
  transition: all 0.05s;
  letter-spacing: 0.02em;
}

.btn-green {
  background: var(--green);
  color: white;
  box-shadow: 3px 3px 0 var(--green-dark);
  text-shadow: 1px 1px 0 rgba(0,0,0,0.4);
}
.btn-green:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 var(--green-dark); }

.btn-yellow {
  background: var(--accent);
  color: var(--text-dark);
  box-shadow: 3px 3px 0 var(--accent-dark);
}
.btn-yellow:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 var(--accent-dark); }

.btn-gray {
  background: var(--panel-dark);
  color: white;
  box-shadow: 3px 3px 0 var(--border-dark);
}
.btn-gray:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 var(--border-dark); }

.btn-sm {
  width: auto;
  padding: 4px 8px;
  font-size: 7px;
}

/* â”€â”€ List items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 9px;
  background: var(--panel-light);
  border: 2px solid var(--border-mid);
  border-left: 4px solid var(--border-dark);
  margin-bottom: 4px;
}

.list-item.tap { cursor: pointer; }
.list-item.tap:active { background: #c8dce8; border-left-color: var(--accent); }

.list-item .name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-dark); font-size: 17px; }
.list-item .meta { color: var(--muted); font-size: 15px; flex-shrink: 0; }

.del-btn {
  background: var(--red);
  border: 2px solid var(--border-dark);
  cursor: pointer;
  color: white;
  font-size: 11px;
  font-family: 'Press Start 2P', monospace;
  padding: 3px 6px;
  flex-shrink: 0;
  line-height: 1;
}

/* â”€â”€ Category badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-badge {
  font-size: 8px;
  padding: 2px 5px;
  font-family: 'Press Start 2P', monospace;
  flex-shrink: 0;
  border: 2px solid rgba(0,0,0,0.35);
  color: white;
}

.cat-Food       { background: var(--food); }
.cat-Service    { background: var(--service); }
.cat-Recreation { background: var(--recreation); }
.cat-Creative   { background: var(--creative); }
.cat-Retail     { background: var(--retail); }
.dot-Food       { background: var(--food); }
.dot-Service    { background: var(--service); }
.dot-Recreation { background: var(--recreation); }
.dot-Creative   { background: var(--creative); }
.dot-Retail     { background: var(--retail); }

/* â”€â”€ Resident expand/edit inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.resident-card {
  background: var(--panel-light);
  border: 2px solid var(--border-mid);
  border-left: 4px solid var(--border-dark);
  margin-bottom: 6px;
  overflow: hidden;
  transition: border-left-color 0.1s;
}

.resident-card.expanded { border-left-color: var(--accent); }

.resident-row {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 9px 10px;
  cursor: pointer;
  user-select: none;
}

.resident-row:active { background: #c8dce8; }

.resident-chevron {
  font-size: 14px;
  color: var(--muted);
  flex-shrink: 0;
  transition: transform 0.15s;
  font-family: 'Press Start 2P', monospace;
}

.resident-card.expanded .resident-chevron { transform: rotate(90deg); }

.resident-edit-panel {
  display: none;
  padding: 10px 12px 12px;
  border-top: 2px solid var(--border-mid);
  background: var(--panel-gray);
}

.resident-card.expanded .resident-edit-panel { display: block; }

.edit-row {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

/* â”€â”€ Fav star â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fav-star { color: var(--accent); font-size: 16px; }

/* â”€â”€ Image import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.import-zone {
  border: 3px dashed var(--border-mid);
  background: var(--panel-light);
  padding: 16px 12px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 10px;
  position: relative;
}

.import-zone:active { border-color: var(--accent); background: #e8f4ff; }

.import-zone input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer;
  width: 100%; height: 100%; border: none; padding: 0;
}

.import-icon { font-size: 28px; display: block; margin-bottom: 4px; }
.import-label { font-family: 'Press Start 2P', monospace; font-size: 7px; color: var(--text-mid); line-height: 1.8; display: block; }
.import-sub { font-size: 14px; color: var(--muted); margin-top: 2px; display: block; }

.parse-status {
  font-size: 14px; padding: 7px 10px; border: 2px solid var(--border-mid);
  background: var(--panel-dark); color: var(--text-light); margin-bottom: 10px;
  display: none; align-items: center; gap: 8px;
}

.parse-status.visible { display: flex; }
.parse-status.error { background: var(--red); border-color: #800; }
.parse-status.success { background: var(--green); border-color: var(--green-dark); }

.spinner {
  width: 14px; height: 14px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

.preview-resident {
  background: #e0f0e0;
  border: 2px solid var(--green);
  padding: 6px 9px;
  margin-bottom: 4px;
  font-size: 15px;
  color: var(--text-dark);
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
}

.preview-resident .pr-name { font-weight: bold; flex: 1; min-width: 100px; }
.preview-resident .pr-skills { font-size: 13px; color: var(--muted); }
.preview-resident .pr-fav { font-size: 13px; color: var(--recreation); font-style: italic; }

.preview-hdr {
  font-family: 'Press Start 2P', monospace; font-size: 7px; color: var(--text-mid);
  margin-bottom: 6px; padding-bottom: 4px; border-bottom: 2px solid var(--border-mid);
}

#preview-area { display: none; margin-bottom: 10px; }

.divider-or {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 10px; color: var(--muted); font-size: 14px;
}
.divider-or::before, .divider-or::after { content: ''; flex: 1; height: 2px; background: var(--border-mid); }

/* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar {
  display: flex;
  border: 3px solid var(--border-dark);
  box-shadow: 3px 3px 0 var(--border-dark);
  margin-bottom: 12px;
}

.stat {
  flex: 1; display: flex; flex-direction: column; gap: 1px;
  padding: 8px 6px; border-right: 3px solid var(--border-dark);
  background: var(--panel-gray);
  text-align: center;
}
.stat:last-child { border-right: none; }
.stat .val { font-family: 'Press Start 2P', monospace; font-size: 11px; color: var(--text-dark); }
.stat .lbl { color: var(--muted); font-size: 12px; }

/* â”€â”€ Warning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.warning {
  background: rgba(240,192,0,0.18);
  border: 3px solid var(--accent);
  padding: 8px 12px; font-size: 16px; color: var(--text-dark);
  margin-bottom: 12px; box-shadow: 2px 2px 0 var(--accent-dark);
}

/* â”€â”€ Shop cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.shop-card {
  background: var(--panel-gray);
  border: 3px solid var(--border-dark);
  box-shadow: 3px 3px 0 var(--border-dark);
  margin-bottom: 10px;
}

.shop-card-hdr {
  padding: 8px 12px;
  display: flex; align-items: center; gap: 9px;
  border-bottom: 3px solid var(--border-dark);
  background: var(--floor-hdr);
}

.shop-name {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px; flex: 1; color: white;
  text-shadow: 1px 1px 0 var(--border-dark);
}

.shop-score { text-align: right; }
.shop-score strong { display: block; font-family: 'Press Start 2P', monospace; font-size: 11px; color: var(--accent); }
.shop-score span { font-size: 13px; color: rgba(255,255,255,0.7); }

.workers-list { padding: 6px 12px 8px; }

.worker-row {
  display: flex; align-items: center; gap: 9px;
  padding: 5px 0; border-bottom: 2px dashed var(--floor-stripe);
  font-size: 17px; color: var(--text-dark);
}
.worker-row:last-child { border-bottom: none; }
.worker-name { flex: 1; }
.worker-skill { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }

.skill-bar-wrap { display: flex; gap: 2px; align-items: center; }
.skill-block { width: 7px; height: 10px; background: var(--floor-stripe); border: 1px solid var(--border-mid); }
.skill-block.filled { border-color: rgba(0,0,0,0.25); }
.skill-num { font-family: 'Press Start 2P', monospace; font-size: 9px; width: 13px; text-align: right; }

.fav-star-anim { color: var(--accent); animation: blink 1.2s step-end infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.15} }

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  background: var(--panel-gray);
  border: 3px solid var(--border-dark);
  box-shadow: 3px 3px 0 var(--border-dark);
  text-align: center;
  padding: 40px 16px;
}
.empty-state h3 { font-family: 'Press Start 2P', monospace; font-size: 10px; margin-bottom: 10px; color: var(--text-dark); line-height: 1.8; }
.empty-state p { font-size: 17px; color: var(--muted); }

.section-div { font-size: 15px; color: var(--text-mid); padding: 4px 0; margin-bottom: 5px; border-bottom: 2px solid var(--border-mid); }
.edit-hint { font-size: 13px; color: var(--muted); text-align: center; margin-bottom: 6px; }
.empty-slot { color: var(--muted); font-size: 15px; padding: 4px 0; }
</style>
</head>
<body>

<!-- App Header -->
<div class="app-header">
  <svg class="tower-art" viewBox="0 0 52 68" xmlns="http://www.w3.org/2000/svg" style="image-rendering:pixelated">
    <rect width="52" height="68" fill="#5ec8f0"/>
    <rect x="10" y="10" width="32" height="58" fill="#b8c8d4"/>
    <rect x="10" y="10" width="32" height="4" fill="#6888a0"/>
    <rect x="10" y="24" width="32" height="4" fill="#6888a0"/>
    <rect x="10" y="38" width="32" height="4" fill="#6888a0"/>
    <rect x="10" y="52" width="32" height="4" fill="#6888a0"/>
    <rect x="14" y="14" width="8" height="8" fill="#f0c000"/>
    <rect x="30" y="14" width="8" height="8" fill="#d8e8f4"/>
    <rect x="14" y="28" width="8" height="8" fill="#8820b0"/>
    <rect x="30" y="28" width="8" height="8" fill="#1060c0"/>
    <rect x="14" y="42" width="8" height="8" fill="#148828"/>
    <rect x="30" y="42" width="8" height="8" fill="#e03030"/>
    <rect x="20" y="56" width="12" height="12" fill="#3a5060"/>
    <rect x="8" y="6" width="36" height="6" fill="#6888a0"/>
    <rect x="12" y="2" width="28" height="6" fill="#6888a0"/>
    <rect x="24" y="0" width="4" height="3" fill="#f0c000"/>
    <rect x="10" y="10" width="32" height="58" fill="none" stroke="#3a5060" stroke-width="2"/>
  </svg>
  <div>
    <div class="logo">TINY TOWER</div>
    <div class="tagline">// Staff Optimizer</div>
  </div>
  <div class="header-badges">
    <div class="badge" id="hdr-residents">0 RES</div>
    <div class="badge" id="hdr-shops">0 SHOPS</div>
  </div>
</div>

<!-- Pages -->
<div class="pages">

  <!-- PAGE 1: Data Entry -->
  <div class="page active" id="page-entry">
    <div class="panel">
      <div class="panel-hdr">DATA ENTRY</div>
      <div class="panel-body">
        <div class="inner-tabs">
          <button class="inner-tab active" onclick="switchInner('residents')">RESIDENTS</button>
          <button class="inner-tab" onclick="switchInner('shops')">SHOPS</button>
        </div>

        <!-- Add Resident -->
        <div id="inner-residents">
          <!-- Image import -->
          <div class="import-zone" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
            <input type="file" accept="image/*" onchange="handleImageFile(this.files[0])">
            <span class="import-icon">ğŸ“·</span>
            <span class="import-label">SCAN SCREENSHOT</span>
            <span class="import-sub">Tap to upload a residents page</span>
          </div>
          <div class="parse-status" id="parse-status">
            <div class="spinner" id="parse-spinner"></div>
            <span id="parse-msg">Scanning...</span>
          </div>
          <div id="preview-area">
            <div class="preview-hdr">FOUND RESIDENTS â€” CONFIRM TO ADD</div>
            <div id="preview-list"></div>
            <div style="display:flex;gap:6px;margin-top:8px;">
              <button class="btn btn-green" style="flex:2" onclick="confirmImport()">âœ“ ADD ALL</button>
              <button class="btn btn-gray" style="flex:1" onclick="cancelImport()">âœ— CANCEL</button>
            </div>
          </div>
          <div class="divider-or">or add manually</div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="r-name" placeholder="e.g. Alex">
          </div>
          <div class="skill-grid">
            <div class="skill-item" id="sk-Food">
              <label><span class="skill-dot dot-Food"></span>Food</label>
              <div class="skill-input-wrap">
                <input type="range" min="0" max="9" value="5" oninput="this.nextElementSibling.textContent=this.value">
                <span class="skill-val">5</span>
              </div>
            </div>
            <div class="skill-item" id="sk-Service">
              <label><span class="skill-dot dot-Service"></span>Service</label>
              <div class="skill-input-wrap">
                <input type="range" min="0" max="9" value="5" oninput="this.nextElementSibling.textContent=this.value">
                <span class="skill-val">5</span>
              </div>
            </div>
            <div class="skill-item" id="sk-Recreation">
              <label><span class="skill-dot dot-Recreation"></span>Rec</label>
              <div class="skill-input-wrap">
                <input type="range" min="0" max="9" value="5" oninput="this.nextElementSibling.textContent=this.value">
                <span class="skill-val">5</span>
              </div>
            </div>
            <div class="skill-item" id="sk-Creative">
              <label><span class="skill-dot dot-Creative"></span>Creative</label>
              <div class="skill-input-wrap">
                <input type="range" min="0" max="9" value="5" oninput="this.nextElementSibling.textContent=this.value">
                <span class="skill-val">5</span>
              </div>
            </div>
            <div class="skill-item" id="sk-Retail">
              <label><span class="skill-dot dot-Retail"></span>Retail</label>
              <div class="skill-input-wrap">
                <input type="range" min="0" max="9" value="5" oninput="this.nextElementSibling.textContent=this.value">
                <span class="skill-val">5</span>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Dream Job (optional â€” future shops OK)</label>
            <input type="text" id="r-fav" placeholder="e.g. Sushi Bar" list="shops-datalist">
            <datalist id="shops-datalist"></datalist>
          </div>
          <button class="btn btn-green" onclick="addResident()">+ ADD RESIDENT</button>
        </div>

        <!-- Add Shop -->
        <div id="inner-shops" style="display:none;">
          <div class="form-group">
            <label>Shop Name</label>
            <input type="text" id="s-name" placeholder="e.g. Sushi Bar">
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="s-cat">
              <option value="Food">Food</option>
              <option value="Service">Service</option>
              <option value="Recreation">Recreation</option>
              <option value="Creative">Creative</option>
              <option value="Retail">Retail</option>
            </select>
          </div>
          <div class="form-group">
            <label>Staff Slots</label>
            <select id="s-slots">
              <option value="1">1 worker</option>
              <option value="2">2 workers</option>
              <option value="3" selected>3 workers</option>
            </select>
          </div>
          <button class="btn btn-green" onclick="addShop()">+ ADD SHOP</button>
          <div style="margin-top:14px;">
            <div class="section-div">SHOPS (<span id="s-count">0</span>)</div>
            <div id="shop-list"><div class="empty-slot">No shops yet</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGE 2: Residents -->
  <div class="page" id="page-residents">
    <div id="residents-content">
      <div class="empty-state">
        <div style="font-size:40px;margin-bottom:10px;">ğŸ‘¥</div>
        <h3>NO RESIDENTS</h3>
        <p>Add residents in Data Entry</p>
      </div>
    </div>
  </div>

  <!-- PAGE 3: Assignments -->
  <div class="page" id="page-assignments">
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
      <button class="btn btn-yellow" style="flex:1;min-width:120px;" onclick="runOptimizer()">â–¶ OPTIMIZE</button>
      <label style="display:flex;align-items:center;gap:6px;font-size:15px;color:white;text-shadow:1px 1px 0 var(--border-dark);cursor:pointer;flex-shrink:0;">
        <input type="checkbox" id="lock-existing" checked style="cursor:pointer;accent-color:var(--accent);">
        Preserve assignments
      </label>
    </div>
    <div id="results-area">
      <div class="empty-state">
        <div style="font-size:40px;margin-bottom:10px;">ğŸ¢</div>
        <h3>NO ASSIGNMENTS</h3>
        <p>Add data, then press OPTIMIZE</p>
      </div>
    </div>
  </div>

</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-btn active" onclick="switchPage('entry', this)">
    <span class="nav-icon">âœï¸</span>
    <span>DATA</span>
  </button>
  <button class="nav-btn" onclick="switchPage('residents', this)">
    <span class="nav-icon">ğŸ‘¥</span>
    <span>RESIDENTS</span>
    <span class="nav-badge" id="nav-res-count" style="display:none">0</span>
  </button>
  <button class="nav-btn" onclick="switchPage('assignments', this)">
    <span class="nav-icon">ğŸ¢</span>
    <span>ASSIGN</span>
  </button>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let residents = [], shops = [], assignments = {}, nextId = 1;
const CATS = ['Food','Service','Recreation','Creative','Retail'];
const CAT_COLORS = { Food:'#e03030', Service:'#d07800', Recreation:'#148828', Creative:'#8820b0', Retail:'#1060c0' };

// â”€â”€â”€ Page navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
}

// â”€â”€â”€ Inner tabs (Data Entry) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchInner(tab) {
  document.getElementById('inner-residents').style.display = tab === 'residents' ? '' : 'none';
  document.getElementById('inner-shops').style.display = tab === 'shops' ? '' : 'none';
  document.querySelectorAll('.inner-tab').forEach((t, i) =>
    t.classList.toggle('active', (i === 0 && tab === 'residents') || (i === 1 && tab === 'shops')));
}

// â”€â”€â”€ Update header badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBadges() {
  document.getElementById('hdr-residents').textContent = residents.length + ' RES';
  document.getElementById('hdr-shops').textContent = shops.length + ' SHOPS';
  const nb = document.getElementById('nav-res-count');
  nb.textContent = residents.length;
  nb.style.display = residents.length ? '' : 'none';
}

// â”€â”€â”€ Add Resident â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addResident() {
  const name = document.getElementById('r-name').value.trim();
  if (!name) return alert('Please enter a name.');
  if (residents.find(r => r.name.toLowerCase().trim() === name.toLowerCase().trim())) {
    return alert(name + ' already exists. Use the Residents tab to edit them.');
  }
  const skills = {};
  CATS.forEach(c => { skills[c] = parseInt(document.querySelector('#sk-' + c + ' input[type=range]').value); });
  const fav = document.getElementById('r-fav').value.trim() || null;
  residents.push({ id: nextId++, name, skills, fav });
  document.getElementById('r-name').value = '';
  document.getElementById('r-fav').value = '';
  updateBadges();
  renderResidentPage();
}

// â”€â”€â”€ Add Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addShop() {
  const name = document.getElementById('s-name').value.trim();
  if (!name) return alert('Please enter a shop name.');
  if (shops.find(s => s.name.toLowerCase().trim() === name.toLowerCase().trim())) {
    return alert(name + ' already exists.');
  }
  const cat = document.getElementById('s-cat').value;
  const slots = parseInt(document.getElementById('s-slots').value);
  shops.push({ id: nextId++, name, cat, slots });
  document.getElementById('s-name').value = '';
  updateFavDropdown();
  renderShopList();
  updateBadges();
}

function deleteResident(id) {
  residents = residents.filter(r => r.id !== id);
  for (const sid in assignments) assignments[sid] = assignments[sid].filter(rid => rid !== id);
  updateBadges();
  renderResidentPage();
}

function deleteShop(id) {
  shops = shops.filter(s => s.id !== id);
  delete assignments[id];
  updateFavDropdown();
  renderShopList();
  updateBadges();
}

// â”€â”€â”€ Resident page: expandable cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResidentPage() {
  const el = document.getElementById('residents-content');
  if (!residents.length) {
    el.innerHTML = `<div class="empty-state">
      <div style="font-size:40px;margin-bottom:10px;">ğŸ‘¥</div>
      <h3>NO RESIDENTS</h3>
      <p>Add residents in Data Entry</p>
    </div>`;
    return;
  }

  el.innerHTML = '<div class="edit-hint">âœ Tap a resident to edit</div>' +
    residents.map(r => {
      const best = CATS.reduce((a, b) => r.skills[a] >= r.skills[b] ? a : b);
      const favShop = r.fav ? shops.find(s => s.name.toLowerCase() === r.fav.toLowerCase()) : null;
      const favLabel = r.fav ? (favShop ? favShop.name : r.fav + ' (??)') : null;
      const shopOpts = '<option value="">â€” None â€”</option>' +
        shops.map(s => `<option value="${s.name}" ${(r.fav && s.name.toLowerCase() === r.fav.toLowerCase()) ? 'selected' : ''}>${s.name} (${s.cat})</option>`).join('');

      const skillSliders = CATS.map(cat => `
        <div class="skill-item" id="esk-${cat}-${r.id}">
          <label><span class="skill-dot dot-${cat}"></span>${cat === 'Recreation' ? 'Rec' : cat}</label>
          <div class="skill-input-wrap">
            <input type="range" min="0" max="9" value="${r.skills[cat] ?? 5}"
              oninput="this.nextElementSibling.textContent=this.value">
            <span class="skill-val">${r.skills[cat] ?? 5}</span>
          </div>
        </div>`).join('');

      return `<div class="resident-card" id="rcard-${r.id}">
        <div class="resident-row" onclick="toggleResident(${r.id})">
          <span class="cat-badge cat-${best}">${best[0]}</span>
          <span class="name" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-dark);font-size:17px;">${r.name}</span>
          ${favLabel ? `<span class="fav-star" title="Dream: ${favLabel}">${favShop ? 'â˜…' : 'â˜†'}</span>` : ''}
          <span class="meta" style="color:var(--muted);font-size:15px;flex-shrink:0;">${best[0]}:${r.skills[best]}</span>
          <span class="resident-chevron">â–¶</span>
        </div>
        <div class="resident-edit-panel">
          <div class="skill-grid">${skillSliders}</div>
          <div class="form-group">
            <label>Dream Job</label>
            <select id="efav-${r.id}">${shopOpts}</select>
          </div>
          <div class="edit-row">
            <button class="btn btn-green" style="flex:2;" onclick="saveResident(${r.id})">âœ“ SAVE</button>
            <button class="btn btn-gray" style="flex:1;" onclick="toggleResident(${r.id})">CANCEL</button>
            <button class="btn" style="flex:0;padding:10px 12px;background:var(--red);color:white;border-color:var(--border-dark);" onclick="if(confirm('Delete ${r.name.replace(/'/g,"\\'")}?'))deleteResident(${r.id})">ğŸ—‘</button>
          </div>
        </div>
      </div>`;
    }).join('');
}

function toggleResident(id) {
  const card = document.getElementById('rcard-' + id);
  card.classList.toggle('expanded');
}

function saveResident(id) {
  const r = residents.find(x => x.id === id);
  if (!r) return;
  CATS.forEach(cat => {
    const slider = document.querySelector('#esk-' + cat + '-' + id + ' input[type=range]');
    if (slider) r.skills[cat] = parseInt(slider.value);
  });
  const favSel = document.getElementById('efav-' + id);
  r.fav = favSel ? (favSel.value || null) : r.fav;
  renderResidentPage();
}

// â”€â”€â”€ Shop list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShopList() {
  const el = document.getElementById('shop-list');
  document.getElementById('s-count').textContent = shops.length;
  if (!shops.length) { el.innerHTML = '<div class="empty-slot">No shops yet</div>'; return; }
  el.innerHTML = shops.map(s => `<div class="list-item">
    <span class="cat-badge cat-${s.cat}">${s.cat[0]}</span>
    <span class="name">${s.name}</span>
    <span class="meta">${s.slots} slots</span>
    <button class="del-btn" onclick="deleteShop(${s.id})">X</button>
  </div>`).join('');
}

function updateFavDropdown() {
  document.getElementById('shops-datalist').innerHTML = shops.map(s => `<option value="${s.name}">`).join('');
}

// â”€â”€â”€ Optimizer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runOptimizer() {
  if (!shops.length) return alert('Add at least one shop first.');
  if (!residents.length) return alert('Add at least one resident first.');

  const lockExisting = document.getElementById('lock-existing').checked;
  const newAssignments = {};

  if (lockExisting && Object.keys(assignments).length > 0) {
    for (const [shopId, rids] of Object.entries(assignments)) {
      const shop = shops.find(s => s.id === parseInt(shopId));
      if (!shop) continue;
      newAssignments[shopId] = rids.filter(rid => residents.find(r => r.id === rid)).slice(0, shop.slots);
    }
  }

  shops.forEach(shop => { if (!newAssignments[shop.id]) newAssignments[shop.id] = []; });
  const assigned = new Set(Object.values(newAssignments).flat());

  const shopPriority = shops.map(shop => {
    const avail = residents.filter(r => !assigned.has(r.id));
    return { shop, scarcity: avail.filter(r => r.skills[shop.cat] >= 5).length / shop.slots };
  }).sort((a, b) => a.scarcity - b.scarcity);

  for (const { shop } of shopPriority) {
    const need = shop.slots - newAssignments[shop.id].length;
    if (need <= 0) continue;
    const candidates = residents.filter(r => !assigned.has(r.id));
    candidates.sort((a, b) => {
      const diff = b.skills[shop.cat] - a.skills[shop.cat];
      if (diff !== 0) return diff;
      const aFav = a.fav && a.fav.toLowerCase() === shop.name.toLowerCase() ? 2 : 0;
      const bFav = b.fav && b.fav.toLowerCase() === shop.name.toLowerCase() ? 2 : 0;
      if (bFav !== aFav) return bFav - aFav;
      const aFS = a.fav ? shops.find(s => s.name.toLowerCase() === a.fav.toLowerCase()) : null;
      const bFS = b.fav ? shops.find(s => s.name.toLowerCase() === b.fav.toLowerCase()) : null;
      return (bFS && bFS.cat === shop.cat ? 1 : 0) - (aFS && aFS.cat === shop.cat ? 1 : 0);
    });
    for (let i = 0; i < need && i < candidates.length; i++) {
      newAssignments[shop.id].push(candidates[i].id);
      assigned.add(candidates[i].id);
    }
  }

  assignments = newAssignments;
  renderResults();
}

function renderResults() {
  const el = document.getElementById('results-area');
  let totalSkill = 0, totalSlots = 0, filledSlots = 0;
  shops.forEach(shop => {
    const rids = assignments[shop.id] || [];
    totalSlots += shop.slots;
    filledSlots += rids.length;
    rids.forEach(rid => { const r = residents.find(x => x.id === rid); if (r) totalSkill += r.skills[shop.cat]; });
  });
  const pct = filledSlots > 0 ? Math.round((totalSkill / (filledSlots * 9)) * 100) : 0;
  const unplaced = residents.length - filledSlots;

  el.innerHTML = `
    <div class="stats-bar">
      <div class="stat"><span class="val">${totalSkill}</span><span class="lbl">Skill</span></div>
      <div class="stat"><span class="val">${pct}%</span><span class="lbl">Effic.</span></div>
      <div class="stat"><span class="val">${filledSlots}/${totalSlots}</span><span class="lbl">Filled</span></div>
      <div class="stat"><span class="val">${unplaced}</span><span class="lbl">Unplaced</span></div>
    </div>
    ${unplaced > 0 && residents.length > filledSlots ? `<div class="warning">âš  ${unplaced} resident${unplaced > 1 ? 's' : ''} unplaced â€” add more slots.</div>` : ''}
    <div class="results-grid">${shops.map(renderShopCard).join('')}</div>`;
}

function renderShopCard(shop) {
  const rids = assignments[shop.id] || [];
  const workers = rids.map(rid => residents.find(r => r.id === rid)).filter(Boolean);
  const totalSk = workers.reduce((s, r) => s + r.skills[shop.cat], 0);
  const color = CAT_COLORS[shop.cat];
  const rows = [];
  for (let i = 0; i < shop.slots; i++) {
    const w = workers[i];
    if (w) {
      const sk = w.skills[shop.cat];
      const isFav = w.fav && w.fav.toLowerCase() === shop.name.toLowerCase();
      const blocks = Array.from({ length: 9 }, (_, j) =>
        `<div class="skill-block ${j < sk ? 'filled' : ''}" style="${j < sk ? 'background:' + color : ''}"></div>`).join('');
      rows.push(`<div class="worker-row">
        <span class="worker-name">${w.name}${isFav ? ' <span class="fav-star-anim">â˜…</span>' : ''}</span>
        <div class="worker-skill">
          <div class="skill-bar-wrap">${blocks}</div>
          <span class="skill-num" style="color:${color}">${sk}</span>
        </div>
      </div>`);
    } else {
      rows.push(`<div class="worker-row"><span class="empty-slot">[ EMPTY ]</span></div>`);
    }
  }
  return `<div class="shop-card">
    <div class="shop-card-hdr">
      <span class="cat-badge cat-${shop.cat}">${shop.cat}</span>
      <span class="shop-name">${shop.name.toUpperCase()}</span>
      <div class="shop-score"><strong>${totalSk}</strong><span>/${shop.slots * 9}</span></div>
    </div>
    <div class="workers-list">${rows.join('')}</div>
  </div>`;
}

// â”€â”€â”€ Image Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingImport = [];

function handleDrop(e) {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) handleImageFile(file);
}

function handleImageFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => parseResidentsFromImage(e.target.result.split(',')[1], file.type);
  reader.readAsDataURL(file);
}

function setStatus(msg, type) {
  const el = document.getElementById('parse-status');
  el.className = 'parse-status visible' + (type ? ' ' + type : '');
  document.getElementById('parse-msg').textContent = msg;
  document.getElementById('parse-spinner').style.display = type ? 'none' : 'block';
}

function hideStatus() {
  document.getElementById('parse-status').className = 'parse-status';
}

async function parseResidentsFromImage(base64Data, mediaType) {
  setStatus('Scanning image...');
  document.getElementById('preview-area').style.display = 'none';
  pendingImport = [];

  const prompt = `This is a screenshot from the mobile game Tiny Tower showing a list of residents.
For each resident visible, extract:
1. Their full name
2. Their 5 skill values shown as digits (in order: Food, Service, Recreation, Retail, Creative)
3. Their dream job / favorite shop (shown below their current job, often in a different color)

Return ONLY a JSON array, no other text, no markdown. Format:
[{"name":"PERRY MITCHELL","skills":{"Food":0,"Service":1,"Recreation":9,"Retail":2,"Creative":9},"fav":"MECHANIC"}]

Notes:
- Skills are 5 colored digits to the right of name, order: Food, Service, Recreation, Retail, Creative
- Dream job is shown in a distinct color (often green/orange) below current job
- UNEMPLOYED residents still have a dream job shown
- Return ALL residents visible`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{ role: 'user', content: [
          { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64Data } },
          { type: 'text', text: prompt }
        ]}]
      })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    const text = data.content.map(b => b.text || '').join('');
    const parsed = JSON.parse(text.replace(/```json|```/g, '').trim());
    if (!Array.isArray(parsed) || !parsed.length) throw new Error('No residents found');
    pendingImport = parsed;
    showPreview(parsed);
    setStatus(`Found ${parsed.length} resident${parsed.length > 1 ? 's' : ''} â€” review below`, 'success');
  } catch (err) {
    console.error(err);
    setStatus('Error: ' + err.message, 'error');
  }
}

function showPreview(parsed) {
  const area = document.getElementById('preview-area');
  const list = document.getElementById('preview-list');
  area.style.display = 'block';
  list.innerHTML = parsed.map((r, i) => {
    const s = r.skills;
    const isDup = !!residents.find(ex => ex.name.toLowerCase().trim() === r.name.toLowerCase().trim());
    return `<div class="preview-resident" style="${isDup ? 'background:#fff0c0;border-color:#d07800;' : ''}">
      <span class="pr-name">${r.name}${isDup ? ' <span style="font-size:11px;color:#a05000">[UPDATE]</span>' : ''}</span>
      <span class="pr-skills">F:${s.Food} S:${s.Service} R:${s.Recreation} Re:${s.Retail} C:${s.Creative}</span>
      ${r.fav ? `<span class="pr-fav">â™¥ ${r.fav}</span>` : ''}
      <button class="del-btn" onclick="removePending(${i})" style="font-size:9px;padding:2px 5px;">X</button>
    </div>`;
  }).join('');
}

function removePending(i) {
  pendingImport.splice(i, 1);
  if (!pendingImport.length) { cancelImport(); return; }
  showPreview(pendingImport);
  setStatus(`${pendingImport.length} resident${pendingImport.length > 1 ? 's' : ''} ready`, 'success');
}

function confirmImport() {
  let added = 0, updated = 0;
  pendingImport.forEach(r => {
    const norm = r.name.toLowerCase().trim();
    const existing = residents.find(ex => ex.name.toLowerCase().trim() === norm);
    if (existing) {
      existing.skills = {
        Food: r.skills.Food ?? existing.skills.Food,
        Service: r.skills.Service ?? existing.skills.Service,
        Recreation: r.skills.Recreation ?? existing.skills.Recreation,
        Retail: r.skills.Retail ?? existing.skills.Retail,
        Creative: r.skills.Creative ?? existing.skills.Creative,
      };
      if (r.fav) existing.fav = r.fav;
      updated++;
    } else {
      residents.push({ id: nextId++, name: r.name, skills: { Food: r.skills.Food ?? 5, Service: r.skills.Service ?? 5, Recreation: r.skills.Recreation ?? 5, Retail: r.skills.Retail ?? 5, Creative: r.skills.Creative ?? 5 }, fav: r.fav || null });
      added++;
    }
  });
  pendingImport = [];
  document.getElementById('preview-area').style.display = 'none';
  const parts = [];
  if (added) parts.push(added + ' added');
  if (updated) parts.push(updated + ' updated');
  if (parts.length) { setStatus(parts.join(', ') + '!', 'success'); setTimeout(hideStatus, 3000); }
  else hideStatus();
  updateBadges();
  renderResidentPage();
}

function cancelImport() {
  pendingImport = [];
  document.getElementById('preview-area').style.display = 'none';
  hideStatus();
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateBadges();
</script>
</body>
</html>
